<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RADSAFE - Intelligent Monitoring</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Configure Tailwind for Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3182ce', // RadSafe Blue
                        secondary: '#ec4899',
                    }
                }
            }
        }
    </script>
    
    <!-- 3. Dark Mode Initializer -->
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <!-- 4. Required Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e5e7eb 100%);
            background-attachment: fixed;
        }
        .dark body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        /* Animations */
        @keyframes letterFadeIn {
            from { opacity: 0; transform: translateY(30px) scale(0.8); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .letter {
            display: inline-block;
            opacity: 0;
            animation: letterFadeIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        #splash-screen.fade-out {
            animation: fadeOut 0.6s ease-out forwards;
        }
        
        #app-content.fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }

        /* Map Dark Mode */
        .dark .leaflet-layer,
        .dark .leaflet-control-zoom-in,
        .dark .leaflet-control-zoom-out,
        .dark .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        
        /* Legend Custom Styles */
        .leaflet-control-legend {
            transition: all 0.3s ease;
        }
        .legend-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .legend-content.open {
            max-height: 500px;
            opacity: 1;
            margin-top: 0.5rem;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Detector Background */
        .detector-bg {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        }
        .dark .detector-bg {
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
        }
        
        /* Smooth Scrolling */
        html { scroll-behavior: smooth; }
    </style>
</head>

<body class="transition-colors duration-300 overflow-hidden">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-gradient-to-br from-blue-900 via-indigo-900 to-slate-900 flex flex-col items-center justify-center z-50">
        <div class="flex flex-col items-center text-white">
            <i class="fa-solid fa-radiation text-8xl mb-8 animate-pulse text-blue-400"></i>
            <div class="flex space-x-2">
                <span class="text-6xl font-extrabold letter" style="animation-delay: 0.1s">R</span>
                <span class="text-6xl font-extrabold letter" style="animation-delay: 0.2s">A</span>
                <span class="text-6xl font-extrabold letter" style="animation-delay: 0.3s">D</span>
                <span class="text-6xl font-extrabold letter" style="animation-delay: 0.4s">S</span>
                <span class="text-6xl font-extrabold letter" style="animation-delay: 0.5s">A</span>
                <span class="text-6xl font-extrabold letter" style="animation-delay: 0.6s">F</span>
                <span class="text-6xl font-extrabold letter" style="animation-delay: 0.7s">E</span>
            </div>
            <p class="mt-4 text-blue-200 opacity-0" style="animation: fadeIn 1s ease-out 1s forwards;">Intelligent Radiation Monitoring</p>
        </div>
    </div>

    <div id="app-content" class="flex h-screen opacity-0">
        
        <!-- Mobile Sidebar Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 md:hidden hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-slate-800 flex flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-30 transition-transform duration-300">
            <!-- Logo -->
            <div class="h-20 flex items-center justify-center border-b border-gray-200 dark:border-slate-800">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-radiation text-3xl text-blue-600 dark:text-blue-400"></i>
                    <span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400">RADSAFE</span>
                </div>
            </div>

            <nav class="flex-1 mt-6 px-4 space-y-2">
                <a href="#dashboard" class="flex items-center px-4 py-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-xl transition-all">
                    <span class="material-icons mr-3">dashboard</span>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#maps" class="flex items-center px-4 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-800 rounded-xl transition-all">
                    <span class="material-icons mr-3">map</span>
                    <span class="font-medium">Spatial Analysis</span>
                </a>
                <a href="#charts-section" class="flex items-center px-4 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-800 rounded-xl transition-all">
                    <span class="material-icons mr-3">show_chart</span>
                    <span class="font-medium">Charts</span>
                </a>
                <a href="#analytics" class="flex items-center px-4 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-800 rounded-xl transition-all">
                    <span class="material-icons mr-3">analytics</span>
                    <span class="font-medium">ML Detection</span>
                </a>
                <a href="#compliance" class="flex items-center px-4 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-slate-800 rounded-xl transition-all">
                    <span class="material-icons mr-3">verified_user</span>
                    <span class="font-medium">Compliance</span>
                </a>
            </nav>

            <!-- Status Indicator -->
            <div class="p-4 border-t border-gray-200 dark:border-slate-800">
                <div class="bg-emerald-100 dark:bg-emerald-900/30 p-3 rounded-xl flex items-center gap-3">
                    <div class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-emerald-800 dark:text-emerald-400">SYSTEM ONLINE</p>
                        <p class="text-[10px] text-emerald-600 dark:text-emerald-500" id="last-update">Updating...</p>
                        <p class="text-[10px] text-emerald-600 dark:text-emerald-500" id="data-count">Waiting...</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden bg-gray-50 dark:bg-slate-950">
            
            <!-- Header -->
            <header class="h-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-gray-200 dark:border-slate-800 z-20">
                <div class="h-full px-6 flex justify-between items-center">
                    <button id="menu-toggle" class="md:hidden text-gray-600 dark:text-gray-400">
                        <span class="material-icons">menu</span>
                    </button>

                    <h1 class="text-xl font-semibold text-gray-800 dark:text-white hidden md:block">Environmental Radiation Monitor</h1>

                    <div class="flex items-center space-x-4">
                        <button id="refresh-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-slate-800 transition-colors">
                            <span class="material-icons">refresh</span>
                        </button>
                        <button id="theme-toggle" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-slate-800 transition-colors">
                            <span class="material-icons dark:hidden">light_mode</span>
                            <span class="material-icons hidden dark:block">dark_mode</span>
                        </button>
                        <button onclick="triggerEmergencyProtocol()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-lg shadow-red-500/30 transition-all animate-pulse">
                            EMERGENCY
                        </button>
                    </div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <main class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth">
                
                <!-- 1. DETECTOR DISPLAY SECTION -->
                <div id="dashboard" class="detector-bg rounded-2xl p-6 shadow-xl border border-blue-100 dark:border-slate-800 relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div class="text-center lg:text-left">
                            <h2 class="text-sm font-bold tracking-wider text-blue-600 dark:text-blue-400 uppercase mb-2">Real-Time Radiation Level</h2>
                            <div class="flex items-center justify-center lg:justify-start gap-4">
                                <span id="detector-display" class="text-5xl md:text-6xl font-mono font-bold text-slate-800 dark:text-white tracking-tighter">0.000 ÂµSv/h</span>
                                <div id="detector-light" class="w-6 h-6 rounded-full bg-gray-300 shadow-inner transition-colors duration-300"></div>
                            </div>
                            <div class="mt-4 flex gap-2 justify-center lg:justify-start">
                                <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300">Geiger-MÃ¼ller</span>
                                <span class="px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300">ESP32 IoT</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 text-center">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Temperature</p>
                                <p id="temperature-display" class="text-lg font-mono font-bold text-slate-700 dark:text-slate-200">-- Â°C</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 text-center">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Humidity</p>
                                <p id="humidity-display" class="text-lg font-mono font-bold text-slate-700 dark:text-slate-200">-- %</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 text-center">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Air Quality</p>
                                <p id="airquality-display" class="text-lg font-mono font-bold text-slate-700 dark:text-slate-200">-- AQI</p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 text-center">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Pressure</p>
                                <p id="pressure-display" class="text-lg font-mono font-bold text-slate-700 dark:text-slate-200">-- hPa</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. SPATIAL ANALYSIS (MAPS) SECTION -->
                <div id="maps" class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-lg border border-gray-200 dark:border-slate-800 flex flex-col">
                        <div class="p-5 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Radiation Point Map</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Real-time GPS data points</p>
                            </div>
                            <div class="flex gap-2 items-center">
                                <span class="text-xs text-gray-500">Pts:</span>
                                <input type="number" id="circle-points" value="8000" class="w-20 px-2 py-1 text-sm bg-gray-50 dark:bg-slate-800 border rounded dark:text-white dark:border-slate-700" placeholder="Pts">
                                <button onclick="updateCircleMap()" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors"><i class="fa-solid fa-sync"></i></button>
                            </div>
                        </div>
                        <div class="h-96 relative z-0">
                            <div id="circle-map" class="h-full w-full z-0 rounded-b-2xl"></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-lg border border-gray-200 dark:border-slate-800 flex flex-col">
                        <div class="p-5 border-b border-gray-100 dark:border-slate-800 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Thermal Interpolation</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">IDW Spatial Analysis</p>
                            </div>
                            <select id="interpolation-method" onchange="updateInterpolationDisplay()" class="text-xs bg-gray-50 dark:bg-slate-800 border dark:border-slate-700 rounded p-1 dark:text-white">
                                <option value="none">No Interpolation Layer</option>
                                <option value="idw">IDW Method</option>
                                <option value="kriging">Kriging</option>
                            </select>
                        </div>
                        <div class="h-96 relative z-0">
                            <div id="heat-map" class="h-full w-full z-0 rounded-b-2xl"></div>
                        </div>
                    </div>
                </div>

                <!-- Hidden Controls -->
                <div class="hidden">
                    <input type="date" id="circle-start-date"><input type="time" id="circle-start-time">
                    <input type="date" id="circle-end-date"><input type="time" id="circle-end-time">
                    <input type="number" id="circle-min-value" value="0"><input type="number" id="circle-max-value" value="10">
                    <input type="checkbox" id="show-circle-index" checked>
                    
                    <input type="number" id="heat-points" value="8000">
                    <input type="date" id="heat-start-date"><input type="time" id="heat-start-time">
                    <input type="date" id="heat-end-date"><input type="time" id="heat-end-time">
                    <input type="number" id="heat-min-value" value="0"><input type="number" id="heat-max-value" value="10">
                    <input type="checkbox" id="show-heat-index" checked>
                </div>
                
                <div id="interpolation-container" class="hidden bg-white dark:bg-slate-900 p-4 rounded-xl shadow-lg text-center">
                     <img id="interpolation-image" class="max-w-full h-auto rounded mx-auto" src="" alt="Interpolation Map" />
                     <div id="interpolation-caption" class="text-sm mt-2 font-medium text-gray-700 dark:text-gray-300"></div>
                </div>

                <!-- 3. STATISTICAL ANALYSIS (CHARTS) SECTION -->
                <div id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl shadow-lg border border-gray-200 dark:border-slate-800">
                        <canvas id="circle-radiationChart" class="w-full h-96"></canvas>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl shadow-lg border border-gray-200 dark:border-slate-800">
                        <canvas id="radiationLocationChart" class="w-full h-96"></canvas>
                        <div id="circle-stats" class="text-xs text-center mt-2 text-gray-500"></div>
                        <div id="circle-annotation-legend" class="flex justify-center gap-4 text-xs mt-1"></div>
                    </div>
                </div>

                <!-- 4. ANALYTICS: ML DETECTION -->
                <div id="analytics" class="grid grid-cols-1 gap-6">
                    <!-- ML Stats Card -->
                    <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl shadow-lg border border-gray-200 dark:border-slate-800">
                        <h3 class="text-lg font-semibold mb-4 text-slate-800 dark:text-white flex items-center gap-2">
                            <i class="fa-solid fa-brain text-purple-500"></i> ML Detection
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-800 rounded-lg">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Rule-Based Alerts</span>
                                <span id="rule-alerts-count" class="font-bold text-slate-800 dark:text-white">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-800 rounded-lg">
                                <span class="text-sm text-gray-600 dark:text-gray-400">ML Anomalies</span>
                                <span id="ml-anomalies-count" class="font-bold text-slate-800 dark:text-white">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-800 rounded-lg">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Detection Rate</span>
                                <span id="detection-rate" class="font-bold text-blue-500">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. ANOMALY TABLE SECTION -->
                <div id="anomalies" class="bg-white dark:bg-slate-900 rounded-2xl shadow-lg border border-gray-200 dark:border-slate-800 overflow-hidden">
                    <div class="p-5 border-b border-gray-100 dark:border-slate-800">
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Active Anomalies</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-slate-800 dark:text-gray-400">
                                <tr>
                                    <th class="px-6 py-3">Time</th>
                                    <th class="px-6 py-3">Level (ÂµSv/h)</th>
                                    <th class="px-6 py-3">Alert</th>
                                    <th class="px-6 py-3">Method</th>
                                    <th class="px-6 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="detailed-anomalies-table">
                                <!-- JS will populate this -->
                                <tr><td colspan="5" class="px-6 py-4 text-center">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <table class="hidden"><tbody id="alerts-summary-table"></tbody><tbody id="detection-methods-table"></tbody></table>
                </div>

                <!-- 6. RADIATION PROTECTION OFFICER DASHBOARD -->
                <div id="compliance" class="bg-white dark:bg-slate-900 rounded-2xl shadow-lg border border-gray-200 dark:border-slate-800 p-6">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Radiation Protection Officer Dashboard</h2>
                    
                    <!-- Alert System -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div id="alert-normal" class="p-4 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-white">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">âœ“</div>
                                <div>
                                    <h3 class="font-bold text-lg">Normal Level</h3>
                                    <p class="text-sm opacity-90">â‰¤ 0.5 ÂµSv/h</p>
                                    <p class="text-xs opacity-75">Safe operational conditions</p>
                                </div>
                            </div>
                        </div>
                        <div id="alert-action" class="p-4 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 text-white">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">âš </div>
                                <div>
                                    <h3 class="font-bold text-lg">Action Level</h3>
                                    <p class="text-sm opacity-90">0.5 - 2.0 ÂµSv/h</p>
                                    <p class="text-xs opacity-75">Increased monitoring required</p>
                                </div>
                            </div>
                        </div>
                        <div id="alert-warning" class="p-4 rounded-xl bg-gradient-to-br from-red-500 to-red-600 text-white">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">âš âš </div>
                                <div>
                                    <h3 class="font-bold text-lg">Warning Level</h3>
                                    <p class="text-sm opacity-90">2.0 - 10.0 ÂµSv/h</p>
                                    <p class="text-xs opacity-75">Immediate action required</p>
                                </div>
                            </div>
                        </div>
                        <div id="alert-emergency" class="p-4 rounded-xl bg-gradient-to-br from-red-900 to-red-950 text-white animate-pulse">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">ðŸš¨</div>
                                <div>
                                    <h3 class="font-bold text-lg">Emergency Level</h3>
                                    <p class="text-sm opacity-90">> 10.0 ÂµSv/h</p>
                                    <p class="text-xs opacity-75">Evacuation protocols activated</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dose Tracking Details -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Dose Tracking & ALARA Compliance</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center">
                                <h4 class="text-sm text-gray-600 dark:text-gray-400 mb-2">Current Dose Rate</h4>
                                <div class="text-3xl font-bold text-slate-800 dark:text-white" id="current-dose-display">0.0 ÂµSv/h</div>
                                <div class="mt-2 text-xs px-3 py-1 rounded-full inline-block bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300" id="dose-status-display">Normal</div>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center">
                                <h4 class="text-sm text-gray-600 dark:text-gray-400 mb-2">Daily Accumulated</h4>
                                <div class="text-3xl font-bold text-slate-800 dark:text-white" id="daily-dose-display">0.0 ÂµSv</div>
                                <div class="mt-2 text-xs px-3 py-1 rounded-full inline-block bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300" id="daily-status-display">Safe</div>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center">
                                <h4 class="text-sm text-gray-600 dark:text-gray-400 mb-2">Monthly Accumulated</h4>
                                <div class="text-3xl font-bold text-slate-800 dark:text-white" id="monthly-dose-display">0.0 ÂµSv</div>
                                <div class="mt-2 text-xs px-3 py-1 rounded-full inline-block bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300" id="monthly-status-display">Safe</div>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center">
                                <h4 class="text-sm text-gray-600 dark:text-gray-400 mb-2">Annual Accumulated</h4>
                                <div class="text-3xl font-bold text-slate-800 dark:text-white" id="annual-dose-display">0.0 ÂµSv</div>
                                <div class="mt-2 text-xs px-3 py-1 rounded-full inline-block bg-emerald-100 text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300" id="annual-status-display">Safe</div>
                            </div>
                        </div>
                    </div>

                    <!-- Regulatory Compliance -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">IAEA & BAEC Regulatory Compliance</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
                                <h4 class="font-semibold text-slate-800 dark:text-white mb-2">Public Dose Limit</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">1 mSv/year (1000 ÂµSv/year)</p>
                                <div class="w-full h-3 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden mb-2">
                                    <div class="h-full bg-gradient-to-r from-emerald-500 via-amber-500 to-red-500" id="public-dose-bar" style="width: 0%"></div>
                                </div>
                                <span class="text-sm font-semibold text-slate-800 dark:text-white" id="public-dose-percent-display">0%</span>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
                                <h4 class="font-semibold text-slate-800 dark:text-white mb-2">Occupational Dose Limit</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">20 mSv/year (20,000 ÂµSv/year)</p>
                                <div class="w-full h-3 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden mb-2">
                                    <div class="h-full bg-gradient-to-r from-emerald-500 via-amber-500 to-red-500" id="occupational-dose-bar" style="width: 0%"></div>
                                </div>
                                <span class="text-sm font-semibold text-slate-800 dark:text-white" id="occupational-dose-percent-display">0%</span>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl">
                                <h4 class="font-semibold text-slate-800 dark:text-white mb-2">Emergency Dose Limit</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">100 mSv/year (100,000 ÂµSv/year)</p>
                                <div class="w-full h-3 bg-gray-200 dark:bg-slate-700 rounded-full overflow-hidden mb-2">
                                    <div class="h-full bg-gradient-to-r from-emerald-500 via-amber-500 to-red-500" id="emergency-dose-bar" style="width: 0%"></div>
                                </div>
                                <span class="text-sm font-semibold text-slate-800 dark:text-white" id="emergency-dose-percent-display">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Emergency Contacts -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Emergency Response Contacts</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl border-l-4 border-blue-500">
                                <h4 class="font-semibold text-slate-800 dark:text-white mb-2">Radiation Safety Officer</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Dr. Mohammad Ali</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">ðŸ“ž +880-1711-234567</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">ðŸ“§ rso@mist.edu.bd</p>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl border-l-4 border-blue-500">
                                <h4 class="font-semibold text-slate-800 dark:text-white mb-2">BAEC Emergency</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Bangladesh Atomic Energy Commission</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">ðŸ“ž +880-2-911-1234</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">ðŸ“§ emergency@baec.gov.bd</p>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl border-l-4 border-blue-500">
                                <h4 class="font-semibold text-slate-800 dark:text-white mb-2">IAEA Emergency</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">International Atomic Energy Agency</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">ðŸ“ž +43-1-2600-0</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">ðŸ“§ emergency@iaea.org</p>
                            </div>
                            <div class="bg-gray-50 dark:bg-slate-800 p-4 rounded-xl border-l-4 border-blue-500">
                                <h4 class="font-semibold text-slate-800 dark:text-white mb-2">Local Emergency</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Fire Service & Civil Defence</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">ðŸ“ž 999</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">ðŸ“ž +880-2-955-5555</p>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-4 justify-center">
                        <button onclick="generateReport()" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            Generate Compliance Report
                        </button>
                        <button onclick="exportData()" class="px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            Export Data
                        </button>
                        <button onclick="openEmergencyEvacuation()" class="px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            Emergency Evacuation
                        </button>
                        <button onclick="triggerEmergencyProtocol()" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 animate-pulse">
                            Emergency Protocol
                        </button>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="text-center text-xs text-gray-400 dark:text-slate-600 mt-8 pb-4">
                    <p>Â© 2025 RADSAFE - Radiation Protection System v2.0</p>
                </footer>

            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml-matrix@6.10.4/lib/ml-matrix.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0/dist/chartjs-plugin-annotation.min.js"></script>

    <script>
        // --- GLOBAL VARIABLES FOR LATEST FEED ACCESS ---
        // Moved to global scope so Legend buttons can access them
        let circleLatestValidFeed = null;
        let heatLatestValidFeed = null;
        let heatDataPoints = [];
        let accumulatedDoses = { daily: 0, monthly: 0, annual: 0, lastUpdate: new Date() };

        // --- UI Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const menuToggle = document.getElementById('menu-toggle');
            const themeToggle = document.getElementById('theme-toggle');
            const splashScreen = document.getElementById('splash-screen');
            const appContent = document.getElementById('app-content');

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });

            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
            });

            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                appContent.classList.remove('opacity-0');
                appContent.classList.add('fade-in');
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    if(typeof circleMap !== 'undefined') circleMap.invalidateSize();
                    if(typeof heatMap !== 'undefined') heatMap.invalidateSize();
                }, 600);
            }, 1500); 
        });

        // --- Core Logic ---
        const YELLOW_THRESHOLD = 0.5;
        const ORANGE_THRESHOLD = 2.0;
        const RED_THRESHOLD = 10.0;

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function interpolateIDW(lat, lon, points, power = 2, maxDistance = 0.01, maxPoints = 10) {
            let hasPointWithin70m = false;
            for (const point of points) {
                if (haversineDistance(lat, lon, point.lat, point.lon) <= 70) {
                    hasPointWithin70m = true;
                    break;
                }
            }
            if (!hasPointWithin70m) return null;

            const distances = points.map(point => ({
                point,
                distance: Math.sqrt(Math.pow(lat - point.lat, 2) + Math.pow(lon - point.lon, 2))
            })).filter(d => d.distance <= maxDistance && d.distance > 0);

            distances.sort((a, b) => a.distance - b.distance);
            const nearest = distances.slice(0, maxPoints);

            if (nearest.length === 0) return null;

            let sumValue = 0, sumWeight = 0;
            nearest.forEach(({ point, distance }) => {
                const weight = 1 / Math.pow(distance, power);
                sumValue += weight * point.val;
                sumWeight += weight;
            });

            return sumValue / sumWeight;
        }

        function updateInterpolationDisplay() {
            const method = document.getElementById('interpolation-method').value;
            const container = document.getElementById('interpolation-container');
            const image = document.getElementById('interpolation-image');
            const caption = document.getElementById('interpolation-caption');

            if (method === 'none') {
                container.classList.add('hidden');
            } else if (method === 'kriging') {
                container.classList.remove('hidden');
                image.src = 'radiation_map.png'; 
                caption.textContent = 'Spatial Distribution (Ordinary Kriging)';
            } else if (method === 'idw') {
                container.classList.remove('hidden');
                image.src = 'idwinterpolation.png'; 
                caption.textContent = 'Spatial Distribution (Inverse Distance Weighted)';
            }
        }

        // --- Maps Initialization ---
        L.GridLayer.Grid = L.GridLayer.extend({
            createTile: function(coords) {
                const tile = document.createElement('canvas');
                const tileSize = this.getTileSize();
                tile.setAttribute('width', tileSize.x);
                tile.setAttribute('height', tileSize.y);
                const ctx = tile.getContext('2d');
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 1;
                ctx.strokeRect(0, 0, tileSize.x, tileSize.y);
                return tile;
            }
        });

        const circleMap = L.map('circle-map', { renderer: L.canvas() }).setView([23.685, 90.3563], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(circleMap);
        const circleMarkers = L.layerGroup().addTo(circleMap);

        const heatMap = L.map('heat-map', { renderer: L.canvas() }).setView([23.685, 90.3563], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(heatMap);
        
        let heatLayer = L.heatLayer([], {
            radius: 50, blur: 40, minOpacity: 0.4, maxZoom: 17,
            gradient: { 0.0: '#3b82f6', 0.33: '#22c55e', 0.66: '#facc15', 1.0: '#ef4444' }
        }).addTo(heatMap);

        // --- NEW: TAILWIND STYLED LEGEND CONTROL ---
        const createLegend = (isCircleMap) => {
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function () {
                const div = L.DomUtil.create('div', 'leaflet-control-legend');
                // Use Tailwind classes within HTML string for modern styling
                div.innerHTML = `
                    <div class="bg-white/90 dark:bg-slate-800/90 backdrop-blur p-3 rounded-xl shadow-2xl border border-gray-200 dark:border-slate-700 min-w-[200px]">
                        <button class="legend-toggle w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-3 rounded-lg mb-0 transition-colors flex justify-between items-center shadow-md">
                            <span>Toggle Legend</span>
                            <i class="fa-solid fa-chevron-down transition-transform duration-300 transform"></i>
                        </button>
                        <div class="legend-content transition-all duration-300 ease-in-out">
                            <div class="space-y-2 mt-3 text-xs">
                                <div class="flex items-center gap-3 p-1 rounded hover:bg-gray-50 dark:hover:bg-slate-700/50">
                                    <span class="w-3 h-3 rounded-full bg-blue-500 shadow-sm ring-2 ring-blue-200 dark:ring-blue-900"></span>
                                    <span class="dark:text-gray-300 font-medium">Normal (â‰¤ 0.5)</span>
                                </div>
                                <div class="flex items-center gap-3 p-1 rounded hover:bg-gray-50 dark:hover:bg-slate-700/50">
                                    <span class="w-3 h-3 rounded-full bg-emerald-500 shadow-sm ring-2 ring-emerald-200 dark:ring-emerald-900"></span>
                                    <span class="dark:text-gray-300 font-medium">Safe (0.5 - 2.0)</span>
                                </div>
                                <div class="flex items-center gap-3 p-1 rounded hover:bg-gray-50 dark:hover:bg-slate-700/50">
                                    <span class="w-3 h-3 rounded-full bg-amber-500 shadow-sm ring-2 ring-amber-200 dark:ring-amber-900"></span>
                                    <span class="dark:text-gray-300 font-medium">Warning (2.0 - 10.0)</span>
                                </div>
                                <div class="flex items-center gap-3 p-1 rounded hover:bg-gray-50 dark:hover:bg-slate-700/50">
                                    <span class="w-3 h-3 rounded-full bg-red-600 shadow-sm ring-2 ring-red-200 dark:ring-red-900 animate-pulse"></span>
                                    <span class="dark:text-gray-300 font-medium">Emergency (> 10.0)</span>
                                </div>
                                <div class="flex items-center gap-3 p-1 rounded hover:bg-gray-50 dark:hover:bg-slate-700/50 mt-2 border-t border-gray-100 dark:border-slate-700 pt-2">
                                    <img src="https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png" class="h-5 drop-shadow-md"> 
                                    <span class="dark:text-gray-300 font-medium">Latest Location</span>
                                </div>
                                <button class="show-latest-btn w-full bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 py-2 rounded-lg mt-2 transition-colors font-medium border border-slate-200 dark:border-slate-600">
                                    <i class="fa-solid fa-crosshairs mr-1"></i> Locate Latest
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Add event listeners securely after creation
                const toggleBtn = div.querySelector('.legend-toggle');
                const contentDiv = div.querySelector('.legend-content');
                const icon = div.querySelector('.fa-chevron-down');
                const latestBtn = div.querySelector('.show-latest-btn');

                L.DomEvent.disableClickPropagation(div);

                toggleBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    contentDiv.classList.toggle('open');
                    icon.style.transform = contentDiv.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
                });

                latestBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const latestFeed = isCircleMap ? circleLatestValidFeed : heatLatestValidFeed;
                    const map = isCircleMap ? circleMap : heatMap;
                    const layer = isCircleMap ? circleMarkers : heatMap;

                    if (latestFeed) {
                        const lat = parseFloat(latestFeed.field4);
                        const lon = parseFloat(latestFeed.field5);
                        const val = parseFloat(latestFeed.field2);
                        
                        const customIcon = L.icon({
                            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                        });

                        L.marker([lat, lon], { icon: customIcon })
                          .addTo(isCircleMap ? circleMarkers : heatMap)
                          .bindPopup(`<div class="font-sans"><strong>Latest Reading</strong><br>Rad: ${val} ÂµSv/h<br>Time: ${new Date(latestFeed.created_at).toLocaleTimeString()}</div>`)
                          .openPopup();

                        map.panTo([lat, lon], { animate: true, duration: 1 });
                    } else {
                        alert("No recent data available yet.");
                    }
                });

                return div;
            };
            return legend;
        };

        // Add legends to maps
        createLegend(true).addTo(circleMap);
        createLegend(false).addTo(heatMap);


        // --- Charts Initialization ---
        const circleCtx = document.getElementById('circle-radiationChart').getContext('2d');
        const circleRadiationChart = new Chart(circleCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Radiation Level (ÂµSv/h)',
                    data: [],
                    borderColor: '#3182ce',
                    backgroundColor: 'rgba(49, 130, 206, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Radiation Level Over Time (Circle Map)',
                        font: { size: 20, family: 'Roboto' },
                        padding: { top: 10, bottom: 20 }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        title: { display: true, text: 'Time', font: { family: 'Roboto' } }
                    },
                    y: {
                        title: { display: true, text: 'Radiation Level (ÂµSv/h)', font: { family: 'Roboto', size: 16 } }
                    }
                }
            }
        });

        const locationCtx = document.getElementById('radiationLocationChart').getContext('2d');
        const radiationLocationChart = new Chart(locationCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Radiation Level (ÂµSv/h)',
                    data: [],
                    backgroundColor: '#3182ce',
                    borderColor: '#2b6cb0',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Radiation Level vs Location Index (Circle Map)',
                        font: { size: 20, family: 'Roboto' },
                        padding: { top: 10, bottom: 20 }
                    },
                    annotation: {
                        annotations: {
                            meanLine: {
                                type: 'line',
                                yMin: 0,
                                yMax: 0,
                                borderColor: 'red',
                                borderWidth: 2,
                                label: {
                                    enabled: true,
                                    content: 'Mean',
                                    position: 'end'
                                }
                            },
                            medianLine: {
                                type: 'line',
                                yMin: 0,
                                yMax: 0,
                                borderColor: 'green',
                                borderWidth: 2,
                                label: {
                                    enabled: true,
                                    content: 'Median',
                                    position: 'end'
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Location Index', font: { family: 'Roboto', size: 16 } }
                    },
                    y: {
                        title: { display: true, text: 'Radiation Level (ÂµSv/h)', font: { family: 'Roboto', size: 16 } },
                        beginAtZero: true
                    }
                }
            }
        });

        // --- Data Fetching ---
        function getColor(value, minVal, maxVal) {
            if (value < 1) return '#3b82f6';
            if (value < 2) return '#22c55e';
            if (value < 3) return '#facc15';
            return '#ef4444';
        }

        function updateEnvironmentalData(feed) {
             if(!feed) return;
             document.getElementById('temperature-display').textContent = parseFloat(feed.field6).toFixed(1) + ' Â°C';
             document.getElementById('humidity-display').textContent = parseFloat(feed.field8).toFixed(1) + ' %';
             document.getElementById('airquality-display').textContent = parseFloat(feed.field3).toFixed(0) + ' AQI';
             document.getElementById('pressure-display').textContent = parseFloat(feed.field7).toFixed(1) + ' hPa';
        }

        // NEW: Function to Calculate Historical Dose from fetched data
        function calculateHistoricalDose(feeds) {
            let daily = 0;
            let monthly = 0;
            let annual = 0;
            
            // Sort feeds by time just in case
            feeds.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

            const now = new Date();
            // Start of today (00:00)
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            // Start of month
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            // Start of year
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            for (let i = 1; i < feeds.length; i++) {
                const prevFeed = feeds[i-1];
                const currFeed = feeds[i];
                
                const prevTime = new Date(prevFeed.created_at);
                const currTime = new Date(currFeed.created_at);
                
                // Calculate duration in hours
                const diffMs = currTime - prevTime;
                const diffHours = diffMs / (1000 * 60 * 60);
                
                // Skip huge gaps (> 15 minutes) where device might be off to avoid overestimation
                // This prevents adding huge dose if device was off for 2 days
                if (diffHours > 0.25) continue; 

                const val = parseFloat(currFeed.field2);
                if (isNaN(val)) continue;

                // Dose for this interval (ÂµSv)
                const intervalDose = val * diffHours;

                // Check time windows
                if (currTime >= startOfYear) annual += intervalDose;
                if (currTime >= startOfMonth) monthly += intervalDose;
                if (currTime >= startOfDay) daily += intervalDose;
            }

            return { daily, monthly, annual, lastUpdate: new Date() };
        }

        function fetchCircleData(limit = 8000) {
            const minVal = parseFloat(document.getElementById('circle-min-value').value);
            const maxVal = parseFloat(document.getElementById('circle-max-value').value);
            const channelId = '2967420';
            const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?results=${limit}`;

            fetch(url).then(res => res.json()).then(data => {
                circleMarkers.clearLayers();
                const times = [], values = [], locValues = [];
                let sumLat = 0, sumLon = 0, count = 0;
                
                // Reset local reference, but update global later
                let tempLatestFeed = null;
                
                let lastTime = null;
                const GAP_THRESHOLD_MS = 5 * 60 * 1000; // 5 minutes

                data.feeds.forEach((feed, index) => {
                    const lat = parseFloat(feed.field4);
                    const lon = parseFloat(feed.field5);
                    const val = parseFloat(feed.field2);
                    const currentTime = new Date(feed.created_at).getTime();
                    
                    if (!isNaN(lat) && !isNaN(lon) && !isNaN(val) && val >= minVal && val <= maxVal) {
                        
                        if (lastTime && (currentTime - lastTime > GAP_THRESHOLD_MS)) {
                            times.push(new Date(lastTime + 1000).toISOString()); 
                            values.push(null); 
                        }

                        times.push(feed.created_at);
                        values.push(val);
                        locValues.push({x: index, y: val});
                        lastTime = currentTime;
                        
                        L.circleMarker([lat, lon], {
                            radius: 6, fillColor: getColor(val, minVal, maxVal),
                            color: '#000', weight: 1, fillOpacity: 0.8
                        }).addTo(circleMarkers).bindPopup(`Rad: ${val} ÂµSv/h<br>Time: ${feed.created_at}`);

                        sumLat += lat; sumLon += lon; count++;
                        tempLatestFeed = feed;
                    }
                });

                // Update GLOBAL variable for Legend
                circleLatestValidFeed = tempLatestFeed;

                // NEW: Calculate historical doses from the 1125 points
                const historical = calculateHistoricalDose(data.feeds);
                accumulatedDoses.daily = historical.daily;
                accumulatedDoses.monthly = historical.monthly;
                accumulatedDoses.annual = historical.annual;
                accumulatedDoses.lastUpdate = new Date(); // Reset ticker base

                if (circleLatestValidFeed) {
                    const latestVal = parseFloat(circleLatestValidFeed.field2);
                    document.getElementById('detector-display').textContent = latestVal.toFixed(3) + ' ÂµSv/h';
                    document.getElementById('detector-light').style.backgroundColor = getColor(latestVal, 0, 10);
                    updateEnvironmentalData(circleLatestValidFeed);
                    updateAlertSystem(latestVal); // This will now use the calculated historical values
                }

                circleRadiationChart.data.labels = times;
                circleRadiationChart.data.datasets[0].data = values;
                circleRadiationChart.update();

                radiationLocationChart.data.labels = locValues.map(d => d.x);
                radiationLocationChart.data.datasets[0].data = locValues.map(d => d.y);
                
                const validVals = values.filter(v => v !== null); 
                const mean = validVals.reduce((a,b)=>a+b, 0)/validVals.length || 0;
                const sorted = [...validVals].sort((a,b)=>a-b);
                const median = sorted[Math.floor(sorted.length/2)] || 0;
                
                document.getElementById('circle-stats').innerHTML = `Mean: ${mean.toFixed(3)} | Median: ${median.toFixed(3)}`;
                radiationLocationChart.options.plugins.annotation.annotations.meanLine.yMin = mean;
                radiationLocationChart.options.plugins.annotation.annotations.meanLine.yMax = mean;
                radiationLocationChart.options.plugins.annotation.annotations.medianLine.yMin = median;
                radiationLocationChart.options.plugins.annotation.annotations.medianLine.yMax = median;
                radiationLocationChart.update();

                const anomalyResults = processAnomalyDetection(data.feeds);
                updateAnomalyDetectionUI(anomalyResults);

                document.getElementById('last-update').textContent = 'Last Update: ' + new Date().toLocaleTimeString();
                document.getElementById('data-count').textContent = `${data.feeds.length} Data Points Loaded`;
            });
        }

        function fetchHeatData(limit = 8000) {
            const channelId = '2967420';
            const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?results=${limit}`;

            fetch(url).then(res => res.json()).then(data => {
                heatDataPoints = [];
                const heatPoints = [];
                let tempLatestHeat = null;
                
                data.feeds.forEach(feed => {
                    const lat = parseFloat(feed.field4);
                    const lon = parseFloat(feed.field5);
                    const val = parseFloat(feed.field2);
                    
                    if (!isNaN(lat) && !isNaN(lon) && !isNaN(val)) {
                        heatDataPoints.push({lat, lon, val, ...feed});
                        const intensity = Math.min(Math.max(val / 10, 0), 1);
                        heatPoints.push([lat, lon, intensity]);
                        tempLatestHeat = feed;
                    }
                });
                
                // Update GLOBAL variable for Legend
                heatLatestValidFeed = tempLatestHeat;
                heatLayer.setLatLngs(heatPoints);
            });
        }

        function processAnomalyDetection(feeds) {
            const results = [];
            const values = feeds.map(f => parseFloat(f.field2)).filter(v => !isNaN(v));
            const mean = values.reduce((a,b)=>a+b,0)/values.length;
            const std = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / values.length);

            feeds.forEach((feed) => {
                const val = parseFloat(feed.field2);
                if(isNaN(val)) return;
                
                let alert = 'Normal';
                let method = 'None';
                
                if(val >= RED_THRESHOLD) { alert = 'Red Alert'; method = 'Rule'; }
                else if(val >= ORANGE_THRESHOLD) { alert = 'Orange Alert'; method = 'Rule'; }
                else if(Math.abs((val - mean) / std) > 2 && val > mean) {
                    alert = 'ML Anomaly'; method = 'Statistical';
                }

                results.push({ 
                    time: feed.created_at, val, alert, method, 
                    lat: parseFloat(feed.field4), lon: parseFloat(feed.field5) 
                });
            });
            return results;
        }

        function updateAnomalyDetectionUI(results) {
            const anomalies = results.filter(r => r.alert !== 'Normal');
            document.getElementById('rule-alerts-count').textContent = results.filter(r => r.method === 'Rule').length;
            document.getElementById('ml-anomalies-count').textContent = results.filter(r => r.method === 'Statistical').length;
            document.getElementById('detection-rate').textContent = (results.length ? (anomalies.length/results.length*100).toFixed(1) : 0) + '%';
            
            const tbody = document.getElementById('detailed-anomalies-table');
            if(anomalies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">No anomalies detected</td></tr>';
            } else {
                tbody.innerHTML = anomalies.slice(0, 10).map(r => `
                    <tr class="bg-white border-b dark:bg-slate-800 dark:border-slate-700 hover:bg-gray-50">
                        <td class="px-6 py-4">${new Date(r.time).toLocaleTimeString()}</td>
                        <td class="px-6 py-4">${r.val.toFixed(3)}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs text-white ${r.alert.includes('Red')?'bg-red-500':r.alert.includes('Orange')?'bg-orange-500':'bg-purple-500'}">${r.alert}</span></td>
                        <td class="px-6 py-4">${r.method}</td>
                        <td class="px-6 py-4">Investigate</td>
                    </tr>
                `).join('');
            }
        }

        function updateAlertSystem(radLevel) {
            const now = new Date();
            const hours = (now - accumulatedDoses.lastUpdate) / 36e5;
            if(hours > 0 && hours < 24) {
                const dose = radLevel * hours;
                accumulatedDoses.daily += dose;
                accumulatedDoses.monthly += dose;
                accumulatedDoses.annual += dose;
            }
            accumulatedDoses.lastUpdate = now;

            // --- RPO DASHBOARD UPDATES ---
            document.getElementById('current-dose-display').textContent = radLevel.toFixed(3) + ' ÂµSv/h';
            document.getElementById('daily-dose-display').textContent = accumulatedDoses.daily.toFixed(3) + ' ÂµSv';
            document.getElementById('monthly-dose-display').textContent = accumulatedDoses.monthly.toFixed(3) + ' ÂµSv';
            document.getElementById('annual-dose-display').textContent = accumulatedDoses.annual.toFixed(3) + ' ÂµSv';

            const publicPercent = Math.min((accumulatedDoses.annual / 1000) * 100, 100);
            const occupationalPercent = Math.min((accumulatedDoses.annual / 20000) * 100, 100);
            const emergencyPercent = Math.min((accumulatedDoses.annual / 100000) * 100, 100);

            document.getElementById('public-dose-bar').style.width = publicPercent + '%';
            document.getElementById('occupational-dose-bar').style.width = occupationalPercent + '%';
            document.getElementById('emergency-dose-bar').style.width = emergencyPercent + '%';

            document.getElementById('public-dose-percent-display').textContent = publicPercent.toFixed(1) + '%';
            document.getElementById('occupational-dose-percent-display').textContent = occupationalPercent.toFixed(1) + '%';
            document.getElementById('emergency-dose-percent-display').textContent = emergencyPercent.toFixed(1) + '%';
        }

        function triggerEmergencyProtocol() {
            if(confirm("ACTIVATE EMERGENCY PROTOCOL? This will notify all contacts.")) {
                alert("PROTOCOL INITIATED. Evacuation routes sent to mobile app.");
            }
        }
        
        // Open emergency evacuation route planner
        function openEmergencyEvacuation() {
            window.open('./emergency_evacuation.html', '_blank');
        }

        function generateReport() { alert("Report generation started..."); }
        function exportData() { alert("Exporting CSV..."); }

        function initApp() {
            fetchCircleData(8000);
            fetchHeatData(8000);
            setInterval(() => {
                fetchCircleData(8000);
                fetchHeatData(8000);
            }, 30000);
        }

        // Start initApp almost immediately (100ms) to ensure charts populate as splash screen fades
        setTimeout(initApp, 100);

        window.addEventListener('resize', () => {
             circleMap.invalidateSize();
             heatMap.invalidateSize();
        });
        
        document.getElementById('refresh-btn').addEventListener('click', () => {
             fetchCircleData(8000);
             fetchHeatData(8000);
        });
        
        window.updateCircleMap = function() {
             const val = document.getElementById('circle-points').value;
             fetchCircleData(val);
        };

    </script>
</body>
</html>
